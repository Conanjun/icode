<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8" />
  <title>聊天库</title>
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
  <meta content="" name="description" />
  <meta content="" name="author" />

  <!-- ================== BEGIN BASE CSS STYLE ================== -->
  <link href="../../assets/plugins/jquery-ui/themes/base/minified/jquery-ui.min.css" rel="stylesheet" />
  <link href="../../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../../assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link href="../../assets/css/animate.min.css" rel="stylesheet" />
  <link href="../../assets/css/style.min.css" rel="stylesheet" />
  <link href="../../assets/plugins/gritter/css/jquery.gritter.css" rel="stylesheet" />
  <link href="../../assets/css/style-responsive.min.css" rel="stylesheet" />
  <link href="../../assets/css/theme/default.css" rel="stylesheet" id="theme" />
  <link href="../../assets/plugins/jquery-file-upload/css/jquery.fileupload.css" rel="stylesheet" />
  <link href="../../assets/plugins/jquery-file-upload/css/jquery.fileupload-ui.css" rel="stylesheet" />
  <!-- ================== END BASE CSS STYLE ================== -->
  <style>
    .m-l-5 {
      margin-left: 3px!important;
    }
  </style>
</head>

<body>
  <!-- #modal-dialog -->
  <div class="modal fade" id="modal-dialog">
    <div class="modal-video-addSrc modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h4 class="modal-title">聊天库</h4>
          <input type="hidden" value="" id="marked1">
          <input type="hidden" value="" id="marked2">
        </div>
        <div class="modal-body">
          <form class="form-synonym form-horizontal" novalidate="novalidate">
            <fieldset>
              <div class="form-group">
                <label class="col-md-3 control-label">问　题<span class="red">&nbsp;*</span></label>
                <div class="col-md-7">
                  <input type="text" placeholder="请输入问题" class="input1-synonym form-control" name="word" maxlength="100">
                </div>
              </div>
              <div class="form-group">
                <label class="col-md-3 control-label">机器人回复<span class="red">&nbsp;*</span></label>
                <div class="col-md-7">
                  <input type="text" placeholder="请输入未审核回复" class="input2-synonym form-control" name="tyc" maxlength="100">
                </div>
              </div>
            </fieldset>
          </form>
        </div>
        <div class="modal-footer">
          <a href="javascript:;" class="ensure-synonym btn btn-sm btn-primary">确认</a>
          <a href="javascript:;" class="btn btn-sm btn-white" data-dismiss="modal">关闭</a>
        </div>
      </div>
    </div>
  </div>
  <div id="page-container" class="fade in">
    <div id="content" class="content">
      <!-- begin breadcrumb -->
      <ol class="breadcrumb pull-right">
        <li><a href="javascript:;">首页</a></li>
        <li><a href="javascript:;">知识库管理</a></li>
        <li>聊天库</li>
      </ol>
      <!-- end breadcrumb -->
      <!-- begin page-header -->
      <h1 class="page-header">聊天库</h1>
      <!-- end page-header -->

      <!-- begin row -->
      <div class="rowNav">
        <!-- begin panel -->
        <div class="panel panel-inverse" data-sortable-id="table-basic-7">
          <div class="panel-body">
            <div class="alert alert-warning fade in m-b-15">
              <strong>友情提示：</strong>聊天库中的问题属于业务范围外的问题，为访客与机器人聊天提供语料。
              <span class="close" data-dismiss="alert">×</span>
            </div>
            <div class="table-responsive">
              <div class="delsBtn btn btn-default pull-right m-l-4">
                <i class="glyphicon glyphicon-trash"></i>
                <span>批量删除</span>
              </div>
              
			   <a href="../../simimi/list?excelFlag=2" class=" btn btn-default pull-right m-l-4">
									<i class="glyphicon glyphicon-download"></i>
									<span>下载模板</span>
							</a>
              <div class="input-group pull-right" style="width:250px;">
                <input type="text" class="search-input-addSrc form-control" placeholder="输入问题">
                <span class="input-group-btn" style="padding-bottom: 0;">
  								<button class="btnSearch btn btn-primary" type="button">
  									<i class="glyphicon glyphicon-search"></i>
  								</button>
                </span>
              </div>
              <button type="button" class="addBtn btn btn-primary m-r-4" data-toggle="modal" data-target="#modal-dialog">
									<i class="glyphicon glyphicon-plus"></i>
									<span>添加问题</span>
							</button>
              <span class="btn btn-primary fileinput-button m-r-4">
                <i class="glyphicon glyphicon-upload"></i>
                <span>问题导入</span>
                <input type="file" accept=".xls,.xlsx" name="file" id="exlfileupload">
              </span>
              <a class="btn btn-primary" href="../../simimi/list?excelFlag=1" target="_blank">
                <i class="glyphicon glyphicon-download"></i>
                <span>问题导出</span>
              </a>


              <table class="table" id="ctb">
                <thead>
                  <tr>
                    <th style="width:10px;"><input class="multCos" type="checkbox"></th>
                    <th>问题</th>
                    <th>机器人回复</th>
                    <th width="100">添加方式</th>
                    <th width="70">操作</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
              <div id="itemContainer"></div>
            </div>
          </div>
        </div>
        <!-- end panel -->
        <!-- end row -->
      </div>
      <!-- end row -->
    </div>
    <!-- begin scroll to top btn -->
    <a href="javascript:;" class="btn btn-icon btn-circle btn-success btn-scroll-to-top fade" data-click="scroll-top"><i class="fa fa-angle-up"></i></a>
    <!-- end scroll to top btn -->
  </div>
  <!-- ================== BEGIN BASE JS ================== -->
  <script src="../../assets/plugins/jquery/jquery-1.9.1.min.js"></script>
  <script src="../../assets/plugins/jquery/jquery-migrate-1.1.0.min.js"></script>
  <script src="../../assets/plugins/jquery-ui/ui/minified/jquery-ui.min.js"></script>
  <script src="../../assets/plugins/bootstrap/js/bootstrap.min.js"></script>
  <!--[if lt IE 9]>
        <script src="../../assets/crossbrowserjs/html5shiv.js"></script>
        <script src="../../assets/crossbrowserjs/respond.min.js"></script>
        <script src="../../assets/crossbrowserjs/excanvas.min.js"></script>
    <![endif]-->
  <script src="../../assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="../../assets/plugins/jquery-cookie/jquery.cookie.js"></script>
  <!-- ================== END BASE JS ================== -->

  <!-- ================== BEGIN PAGE LEVEL JS ================== -->
  <script src="../../assets/js/apps.min.js"></script>
  <!-- ================== END PAGE LEVEL JS ================== -->

  <!-- 必加开始 -->
  <link rel="stylesheet" href="../common/css/radioskin/blue.css">
  <link rel="stylesheet" href="../common/css/commonCSS.css">
  <link href="css/style.css" rel="stylesheet" />

  <script src="../../assets/plugins/gritter/js/jquery.gritter.js"></script>
  <script src="../common/js/bootstrap-paginator.js"></script>
  <script src="../common/js/webuploader.min.js"></script>
  <script src="../common/js/customMethod.js"></script>
  <script src="../common/js/icheck.js"></script>
  <script src="../common/js/jquery.validate.js"></script>
  <script src="../common/js/jquery.validate.custom.js"></script>
  <script src="../common/js/base.js"></script>
  <script src="js/main.js"></script>
  <script src="../../assets/plugins/jquery-file-upload/js/jquery.fileupload.js"></script>
  <!-- 必加结束 -->

  <script>
    $(document).ready(function() {
      App.init();

      $('#modal-dialog [name=word]').addWordCount(100);
      $('#modal-dialog [name=tyc]').addWordCount(100);
      var This = this;
      var type = 1, //素材类型
        pageNo = 1, //当前页
        pageSize = 10, //每页数量
        queryStr = '', //搜索内容
        mode = 2,
        idStr = '', //是否传id
        isJpage = 0, //是否已实例化jpage
        delPage = 0; //是否删除jpage

      //添加
      var validator=$('.form-synonym').validate({
        rules: {
          word: {
            required: true,
          },
          tyc: {
            required: true,
          },
        },
        messages: {
          word: {
            required: "请输入问题！",
          },
          tyc: {
            required: "请输入机器人回复！",
          },
        },
        submitHandler: function() {
          Base.request({
            url: 'simimi/editSimimiInfo' + idStr,
            params: {
              que: $('.input1-synonym').val(),
              ans: $('.input2-synonym').val(),
            },
            callback: function(data) {
              if (data.status) {
                Base.gritter(data.message, false); 
              } else {
                Base.gritter(data.message, true);
                $('.input1-synonym').val(''),
                  $('.input2-synonym').val(''),
                  $('#modal-dialog').modal('hide');
                isJpage = 0;
                initSrc();
              }
            },
          });
        },
      });

      //确认添加聊天库
      $('.ensure-synonym').on('click', function() {
        if($("#marked1").val()==$('.input1-synonym').val().trim()&&$("#marked2").val()==$('.input2-synonym').val().trim()&&$("#modal-dialog").hasClass("old")){
          $('#modal-dialog').modal('hide')
        }else{
          $('.form-synonym').submit();        
        }

      });

      $('#modal-dialog').on('hidden.bs.modal', function (e) {
        $('#modal-dialog .input1-synonym').attr('class',"input1-synonym form-control valid")
        $('#modal-dialog .input2-synonym').attr('class',"input2-synonym form-control valid")
        validator.resetForm()
        $("#marked1").val('');
        $("#marked2").val('');
        $('#modal-dialog').removeClass("old") 
      })
      //ENTER
      $(document).on('keyup', function(e) {
        var $activeEl = $(document.activeElement);

        if (($activeEl.is('.input1-synonym') || $activeEl.is('.input2-synonym')) && (e.keyCode == 13 || e.keyCode == 108)) {
          $('.form-synonym').submit();
        }
      });

      function initSrc() {
        $('#ctb').tableAjaxLoader2(7);
        $.ajax({
          url: '../../simimi/list?' + encodeURI(queryStr),
          data: {
            pageNo: pageNo,
            pageSize: pageSize,
          },
          type:'post',
          datatype:'json',
          cache:false,//不从缓存中去数据
          success: function(data) {
            if (data.status) {
              yunNoty(data.message);
            } else {
              var html = '';
              if (data.list[0]) {
                for (var i = 0; i < data.list.length; i++) {
                  var typeStr = '网络添加';

                  if (data.list[i].Type) { //1
                    typeStr = '人工添加';
                  }
                  html += '<tr Id="' + (data.list[i].Id || '') + '"><td><input class="singleCos" type="checkbox"></td><td>' + (data.list[i].Que || '') + '</td><td>' + (data.list[i].Ans || '') + '</td><td>' +
                    typeStr + '</td><td><a><i class="timeTip edit-synonym glyphicon glyphicon-pencil" title="编辑"></i><i class="timeTip del-synonym glyphicon glyphicon-trash" title="删除"></i></a></td></tr>';
                }

                var options = {
                  data: [data, 'list', 'total'],
                  currentPage: data.currentPage,
                  totalPages: data.totlePages ? data.totlePages : 1,
                  alignment: 'right',
                  onPageClicked: function(event, originalEvent, type, page) {
                    pageNo = page;
                    initSrc();
                  }
                };
                $('#itemContainer').bootstrapPaginator(options);
              } else {
                html += '<tr><td colspan="7" style="text-align:center;"><i class="glyphicon glyphicon-warning-sign"></i>&nbsp;&nbsp;当前纪录为空！</td></tr>';
                $('#itemContainer').empty();
              }
              $('tbody').empty().append(html);
              // 批量删除按钮
              $(".delsBtn").removeClass("btn-primary").addClass("btn-default").attr("disabled",true)
              $(".singleCos").on("ifChanged",function(){
                if($(".singleCos:checked").length>0){
                  $(".delsBtn").removeClass("btn-default").addClass("btn-primary").attr("disabled",false)
                }else{
                    $(".delsBtn").removeClass("btn-primary").addClass("btn-default").attr("disabled",true)
                }
              })

              $('.timeTip').tooltip();
              // 每次页面重新写入时移除全选选中状态
              $('#ctb>thead>tr input[type=checkbox]').iCheck("uncheck") 
              icheckInit();
              $('.del-synonym').on('click', function() {
                var self = this;
                $(self).adcCreator(function() {
                  someonedel(self);
                });
              });
            }
          },
        });
      }
      window.initSrc=initSrc;
      initSrc();

      //全选
      $('body').on('ifChecked', '.multCos', function() {
        $('.singleCos').iCheck('check');
      });
      //全不选
      $('body').on('ifUnchecked', '.multCos', function() {
        $('.singleCos').iCheck('uncheck');
      });

      //确认删除答案或问题
      $('body').on('click', '.delsBtn', function() {
        $(this).adcCreator(function() {
          somedel()
        });
      });

      function somedel() {
        var ids = [];

        $('.singleCos').each(function() {
          var $tr = $(this).parents('tr'),
            id = $tr.attr('Id');

          if ($(this).is(':checked')) {
            ids.push(id);
          }
        });

        if (ids.toString()) {
          Base.request({
            url: 'simimi/delSimimiByIds',
            params: {
              ids: ids.toString(),
            },
            callback: function(data) {
              if (data.status) {
                Base.gritter(data.message, false);
              } else {
                Base.gritter(data.message, true);
                if ($('.singleCos').length == ids.length) {
                  if (pageNo >= 2) {
                    pageNo -= 1;
                  }
                }
                initSrc();
              }
            },
          });
        } else {
          Base.gritter('勾选您要删除的问题', false);
        }
      }

      //添加清空input
      $('.addBtn').on('click', function() {
        $('.input1-synonym').val('');
        $('.input2-synonym').val('');
      });

      $('.tab-addSrc').hide();
      $('.tab-addSrc').eq(0).show();
      var tabIndex = 0;

      //不是修改
      $('.addBtn').on('click', function() {
        idStr = '';
      });

      //修改
      $('body').on('click', '.edit-synonym', function() {
        var $tr = $(this).parents('tr'),
          id = $tr.attr('Id');
        idStr = '?id=' + id;

        $('.input1-synonym').val($tr.find('td:eq(1)').text());
        $('.input2-synonym').val($tr.find('td:eq(2)').text());

        $('#modal-dialog').modal('show');
        $('#modal-dialog').addClass("old")
        $("#marked1").val( $('.input1-synonym').val())
        $("#marked2").val( $('.input2-synonym').val())
      });

      //删除
      function someonedel(obj) {
        var $tr = $(obj).parents('tr'),
          id = $tr.attr('Id');

        Base.request({
          url: 'simimi/delSimimiById',
          params: {
            id: id,
          },
          callback: function(data) {
            if (data.status) {
              Base.gritter(data.message, false);
            } else {
              Base.gritter(data.message, true);

              if ($('.del-synonym').length == 1) {
                if (pageNo >= 2) {
                  pageNo -= 1;
                }
              }
              initSrc();
            }
          },
        });
      }

      //搜索
      $('.btnSearch').on('click', function() {
        if (queryStr.length != 3) {
          queryStr = 'que';
        }
        delPage = 1;
        pageNo = 1;
        isJpage = 0;
        queryStr = (queryStr + '=' + $('.search-input-addSrc').val());
        initSrc();
      });

      //ENTER
      $(document).on('keyup', function(e) {
        var $activeEl = $(document.activeElement);

        if ($activeEl.is('.search-input-addSrc') && (e.keyCode == 13 || e.keyCode == 108)) {
          $('.btnSearch').trigger('click');
        }
      });

      //搜索的字段
      $('.queBtn').on('click', function() {
        $('.sortWord2').html($(this).text() + '<span class="caret"></span>');
        queryStr = 'que';
      });
      $('.ansBtn').on('click', function() {
        $('.sortWord2').html($(this).text() + '<span class="caret"></span>');
        queryStr = 'ans';
      });


      //跳转
      $('.goPage-addSrc a').on('click', function() {
        $('.holder').jPages(parseInt($('.goPage-addSrc input').val()));
        return false;
      });

      //全选文本
      $('.goPage-addSrc input').on('focus', function() {
        $(this).select();
      });

    });

   
    // 进度条函数
    loadingfn('#exlfileupload','../../Simimi/jQueryFileUpload','../../Simimi/getStatus')

    // btnDom               上传按钮的id或class
    // uploadUrl            上传excel的路径
    // getgetStatusUrl      获取上传进度的路径
    // tablefn              页面表格生成的函数名字符串
    // setintertime         获取进度的计时器间隔，不写为400ms
    function loadingfn(btnDom,uploadUrl,getgetStatusUrl){
        // 间隔时间
        var times=400
        // 定义计时器
        var INTERVAL;
        // 进度条dom写入页面
        var jindutiaostr='<div id="exlProgress" style="position:fixed;z-index:99;top:0;right:0;background-color:rgba(0,0,0,0.4);width:100%;height:100%;display:none">';
            jindutiaostr+='<div style="width:329px;margin:25% auto;">';
            jindutiaostr+='<h4 style="text-align:center;color:#1296db;font-size:18px;font-family:'+'微软雅黑'+';text-shadow:1px 1px 2px  #FFFFFF;font-weight:700">Loading...</h4>';
            jindutiaostr+='<div class="progress progress-striped active" style="height:10px;background-color:#dadada;box-shadow:inset 0px 0px 3px lightgray;">';
            jindutiaostr+='<div class="progress-bar" style="background-color:#33b5e2"></div></div></div></div>';
        $("body").append(jindutiaostr)

        //上传
        $(function() {

          'use strict';
          // $('#exlfileupload').fileupload({
          $(btnDom).fileupload({
            // url: '../../WordDocExcel/importFile?mode=2',
            url: uploadUrl,
            dataType: 'json',
            change: function(e, data) {
              
              var flag = true;
              $.each(data.files, function(index, file) {
                var str = file.name.substring(file.name.lastIndexOf(".") + 1);
                if (str == "xls" || str == "xlsx") {
                  flag = true;
                } else {
                  flag = false;
                  yunNotyError("请上传xls或xlsx格式的文件！");
                }
              });
              return flag;

            },
            done: function(e, data) {
              if (data.result.status == 0) {
                $('#exlProgress').show();
                yunNoty(data.result);
                INTERVAL = setInterval(confirmLoad,times)
              } else {
                yunNoty(data.result);
                $('#exlProgress').hide();
                $('#exlProgress .progress-bar').css('width', '0%');
                $('.fileinput-button').css('display', 'inline-block');
                $('.fileUpLoadingSign').css('display', 'none');
              }
            },
          }).bind('fileuploadstart', function(e) {
            $('.fileinput-button').css('display', 'none');
            $('.fileUpLoadingSign').css('display', 'inline-block');
            $('#exlProgress').show();
          }).bind('fileuploadstop', function(e) {
            $('.fileinput-button').css('display', 'inline-block');
            $('.fileUpLoadingSign').css('display', 'none');
          });
        });


        //确认导入
        function confirmLoad(obj) {
          $.ajax({
            type: 'get',
            datatype: 'json',
            cache: false, //不从缓存中去数据
            url: encodeURI(getgetStatusUrl),
            success: function(data) {
              var progress=data.ProgressToKnowledge;
              if (data.ProgressToKnowledge == 100) {
                if (data.ErrorMsg != '') {
                  yunNoty({
                    status: 1,
                    message: data.ErrorMsg
                  });
                } else {
                  yunNoty({
                    status: 0,
                    message: '导入成功！'
                  });
                }
                clearInterval(INTERVAL);
                $('#exlProgress .progress-bar').css(
                  'width',
                  progress + '%'
                )
                $('#exlProgress h4').text(
                  "Loading..."+progress + '%'
                ) 
                setTimeout(function(){
                  $('#exlProgress').hide();
                  $('#exlProgress .progress-bar').css('width', '0%');
                  initSrc();
                },1000)
                       
              } else {    
                $('#exlProgress .progress-bar').css(
                  'width',
                  progress + '%'
                )
                $('#exlProgress h4').text(
                  "Loading..."+progress + '%'
                )   
              }
            },
            error:function(){
              clearInterval(INTERVAL);
              $('#exlProgress').hide();
              $('#exlProgress .progress-bar').css('width', '0%');   
            }
          });
        }
    }


  </script>

</body>

</html>
