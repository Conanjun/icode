<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta charset="utf-8" />
	<title>知识图谱</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
	<meta content="" name="description" />
	<meta content="" name="author" />

	<!-- ================== BEGIN BASE CSS STYLE ================== -->
	<link href="../../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
	<link href="../../assets/css/animate.min.css" rel="stylesheet" />
	<link href="../../assets/css/style.min.css" rel="stylesheet" />
	<link href="../../assets/css/style-responsive.min.css" rel="stylesheet" />
	<link href="../../assets/css/theme/default.css" rel="stylesheet" id="theme" />
	<link href="../../assets/plugins/jquery-ui/themes/base/minified/jquery-ui.min.css" rel="stylesheet" />
	<link href="../../assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
	<link href="../../assets/plugins/gritter/css/jquery.gritter.css" rel="stylesheet" />
	<!-- ================== END BASE CSS STYLE ================== -->

	<link href="../common/css/radioskin/blue.css" rel="stylesheet">
	<link href="../common/css/commonCSS.css" rel="stylesheet">
</head>
<body class="pace-done">
	<div class="fade in hide" id="page-loader"><span class="spinner"></span></div>
	<div id="page-container" class="fade in">
		<div id="content" class="content">
			<ol class="breadcrumb pull-right">
				
			</ol>
			<div class="row">
				<h1 class="page-header">知识图谱</h1>
				<input type="hidden" id="graphUrl" value="">
				<div class="panel">
					<div class="panel-body" style="min-height:500px;">
						<!-- <div class="alert alert-warning fade in m-b-15">
                          <strong>友情提示：</strong>第三方接口是指在机器人的问答业务中，常常遇到需要调用其他业务是同才能完成的问答，如通过产品编号产寻产品，根据业务编号查询办事业务进度等，如果对接身份认证系统，那么可以查询的业务更多，如订单查询，积分查询等等。 当用户输入特定格式的问题时，系统可以通过查询第三方接口的形式回答用户的问题。机器人目前支持http接口的调用方式，数据内容采用json格式标准。
                          <span class="close" data-dismiss="alert">×</span>
                        </div> -->
                        <a data-toggle="modal" class="btn btn-primary" id="addGraphBtn">
							<i class="glyphicon glyphicon-plus"></i>
							<span>添加知识图谱</span>
						</a>
						<!-- <a href="javascript:;" class="btn btn-default pull-right" id="mul-del"><span class="glyphicon glyphicon-trash"></span>&nbsp;批量删除</a> -->

							<table class="table" id="konwledgeGraphList">
								<thead>
									<tr>
										<!-- <th width="50"><input type="checkbox" name="select_rows" class="select_rows" data-tableid="ThirdOpenList"/></th> -->
										<th>标题</th>
										<th>实现类名称</th>
										<th>修改时间</th>
										<!-- <th>适用平台</th>
										<th width="150">添加的时间</th> -->
										<th width="70">操作</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						<div id="pageList"></div>
					</div>
				</div>
			</div>
			<!-- 添加/修改知识图谱模态框 -->
			<div class="modal fade" style="display: none;" aria-hidden="true" id="graphModal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
							<h4 class="modal-title">添加知识图谱</h4>
						</div>
						<div class="modal-body">
							<form method="POST" id="garph_form" class="form-horizontal">
								<fieldset>
									<div class="form-group">
										<label class="col-md-3 control-label">标题<span class="red">&nbsp;*</span></label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入标题" class="form-control" name="title">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">知识图谱的唯一标识<span class="red">&nbsp;*</span></label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入知识图谱的唯一标识" class="form-control" name="graph_mark"></input >
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">询问问题接口地址<span class="red">&nbsp;*</span></label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入询问问题接口地址" class="form-control" name="graph_url1">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">有无帮助反馈接口<span class="red">&nbsp;*</span></label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入有无帮助反馈接口" class="form-control" name="graph_url2">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">输入引导接口<span class="red">&nbsp;*</span></label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入输入引导接口" class="form-control" name="graph_url3"></input>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">实体获取接口</label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入实体获取接口" class="form-control" name="graph_url4"></input>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">属性获取接口</label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入属性获取接口" class="form-control" name="graph_url5">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">关系获取获取接口</label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入关系获取获取接口" class="form-control" name="graph_url6">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">概念获取获取接口</label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入概念获取获取接口" class="form-control" name="graph_url7">
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">机器人答案置信度倾斜</label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入0到1之间的数值，不填则默认为0.5" class="form-control" maxlength="10" name="kgRobotWeight"></input>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">简介</label>
										<div class="col-md-7">
											<textarea type="text" placeholder="请输入简介(不多于200个字符)" class="form-control" name="info" maxlength="200" style="resize:none;"></textarea>
										</div>
									</div>
									<div class="form-group">
										<label class="col-md-3 control-label">实现类名称</label>
										<div class="col-md-7">
											<input type="text" placeholder="请输入实现类名称" class="form-control" name="graph_class">
										</div>
									</div>
								</fieldset>
							</form>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-sm btn-primary" href="javascript:;" onclick="$('#garph_form').submit()">确定</button>
							<a data-dismiss="modal" class="btn btn-sm btn-white" href="javascript:;">取消</a>
						</div>
					</div>
				</div>
			</div>
			<!-- 删除知识图谱确定框 -->
			<div class="modal fade" style="display: none;" aria-hidden="true" id="delModal">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
								<h4 class="modal-title">确认删除</h4>
								<input type="hidden" id="delMark">
							</div>
							<div class="modal-body">
								<p>确定要删除所选内容吗？</p>
							</div>
							<div class="modal-footer">
								<button type="submit" class="btn btn-sm btn-primary" href="javascript:;" onclick="delGraph($('#delModal #delMark').val())">确定</button>
								<a data-dismiss="modal" class="btn btn-sm btn-white" href="javascript:;">取消</a>
							</div>
						</div>
					</div>
				</div>			

		</div>
		<a data-click="scroll-top" class="btn btn-icon btn-circle btn-success btn-scroll-to-top fade" href="javascript:;"><i class="fa fa-angle-up"></i></a>
	</div>
    <!-- ================== BEGIN BASE JS ================== -->
	<script src="../../assets/plugins/jquery/jquery-1.9.1.min.js"></script>
	<script src="../../assets/plugins/jquery/jquery-migrate-1.1.0.min.js"></script>
	<script src="../../assets/plugins/jquery-ui/ui/minified/jquery-ui.min.js"></script>
	<script src="../../assets/plugins/bootstrap/js/bootstrap.min.js"></script>
	<script src="../../assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
	<script src="../../assets/plugins/gritter/js/jquery.gritter.js"></script>
	<script src="../../assets/js/apps.min.js"></script>
	<!--[if lt IE 9]>
		<script src="assets/crossbrowserjs/html5shiv.js"></script>
		<script src="assets/crossbrowserjs/respond.min.js"></script>
		<script src="assets/crossbrowserjs/excanvas.min.js"></script>
	<![endif]-->
	<!-- ================== END BASE JS ================== -->

	<script src="../common/js/bootstrap-paginator.js"></script>
	<script src="../common/js/jquery.validate.js"></script>
	<script src="../common/js/jquery.validate.custom.js"></script>
	<script src="../common/js/icheck.js"></script>
	<script src="../common/js/customMethod.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			App.init();
		// 	$('#mul-del').on('click', function() {
		// 		$(this).adcCreator(function() {
		// 				selectDel('','../../thirdOpen/deleteThirdOpen?type=0',listthirdOpenPage,'pageList')
		// 		});
		//   });
			graphList=[];
			//列出表格			
			listGraphPage(1);
			$('#garph_form [name="info"]').addWordCount(200);
			//添加/修改知识图谱表单验证
			var validate=$('#garph_form').validate({
				rules:{
					title:{
						required:true,
						minlength:1,
						maxlength:200,
					},
					graph_mark:{
						required:true,
						checkMark:true
					},
					graph_url1:{
						biUrl:true	
					},
					graph_url2:{
						biUrl:true
					},
					graph_url3:{
						biUrl:true
					},
					graph_url4:{
						feiUrl:true	
					},
					graph_url5:{
						feiUrl:true
					},
					graph_url6:{
						feiUrl:true
					},
					graph_url7:{
						feiUrl:true
					},
					kgRobotWeight:{
						min:0,
						max:1
					},
					graph_class:{
						isABC:true,
						maxlength:200
					},
				},
				messages:{
					title:{
						required:"请输入名称！",
						minlength:'请输入至少1个字符',
						maxlength:"请输入最多200个字符"
					},
					graph_mark:{
						required:"请输入图谱的唯一标识！",
					},
					kgRobotWeight:{
						min:"请输入0到1之间的数值",
						max:"请输入0到1之间的数值"
					},
					graph_class:{
						isABC:"实现类的名称只能是英文字母！",
						maxlength:"请输入200字符以内"
					}
				},
				submitHandler: addgraph
			});
			// 唯一标识符验证
			$.validator.addMethod("checkMark",function(value,element){
				var reg=/^[0-9a-zA-Z]{2,64}$/
				if(reg.test(value.trim()) ){
					return true;
				}else{
					return false;
				}
			},"请输入2到64位数字或字母");
			// 必填url验证
			$.validator.addMethod("biUrl",function(value,element){
				var reg=/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%/~\+#])?/;
				if(reg.test(value.trim()) ){
					return true;
				}else{
					return false;
				}
			},"请输入正确的网址");
			// 非必填url验证
			$.validator.addMethod("feiUrl",function(value,element){
				var reg=/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%/~\+#])?/;
				if(reg.test(value.trim())||value.trim()==""){
					return true;
				}else{
					return false;
				}
			},"请输入正确的网址");
			
			//点击添加知识图谱
			$("#addGraphBtn").click(function(){
				$("#graphModal .modal-header h4").html("添加知识图谱")//跟换弹出框名称
				$("#graphUrl").val("../../kgmanager/add")//更换接口地址
				$("#graphModal input[name=graph_mark]").removeAttr("disabled")
				$('#graphModal').modal("show")
			})

			//清空表单
			$('#graphModal').on('hidden.bs.modal', function () {
				validate.resetForm();
				$('#graphModal input').val("");	
				$('#graphModal textarea').val("");		
				$('.text-error').removeClass("text-error helper-font-small");
			})
		});
		// 提交/修改知识图谱
		function addgraph(){
			var graphData={
				kgName:$("#graphModal input[name=title]").val(),//知识图谱名称
				kgId:$("#graphModal input[name=graph_mark]").val(),//知识图谱的唯一id编号				
				kgUrlAskQuestion:$("#graphModal input[name=graph_url1]").val(),//询问问题接口地址
				kgUrlUsefulFadeback:$("#graphModal input[name=graph_url2]").val(),//有无帮助反馈接口
				kgUrlInputGuide:$("#graphModal input[name=graph_url3]").val()//输入引导接口地址
			}
			if($("#graphModal input[name=graph_url4]").val().trim()!=""){
				graphData.kgUrlEntity=$("#graphModal input[name=graph_url4]").val()//实体获取接口
			}
			if($("#graphModal input[name=graph_url5]").val().trim()!=""){
				graphData.kgUrlProperty=$("#graphModal input[name=graph_url5]").val()//属性获取接口
			}
			if($("#graphModal input[name=graph_url6]").val().trim()!=""){
				graphData.kgUrlRelation=$("#graphModal input[name=graph_url6]").val()//关系获取接口
			}
			if($("#graphModal input[name=graph_url7]").val().trim()!=""){
				graphData.kgUrlConcept=$("#graphModal input[name=graph_url7]").val()//概念获取接口
			}
			if($("#graphModal input[name=kgRobotWeight]").val()!=""){
				var num=$("#graphModal input[name=kgRobotWeight]").val().trim()
				graphData.kgRobotWeight=Number(num)//机器人答案的置信度倾斜
			}
			if($("#graphModal textarea[name=info]").val().trim()!=""){
				graphData.kgRemark=$("#graphModal textarea[name=info]").val()//简介备注说明
			}
			if($("#graphModal input[name=graph_class]").val().trim()!=""){
				graphData.kgImplClass =$("#graphModal input[name=graph_class]").val()//实现类的名称
			}
			$.ajax({
				type:'post',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI($("#graphUrl").val()),
				data:graphData,
				success:
				function(data){
					if(data.status===0){
						yunNoty(data);
						$('#graphModal').modal('hide');
						listGraphPage(1);
					}else{
						yunNoty(data);
					}
				}
			});
		}

		//单个修改知识图谱
		function editGraph(i){
			$("#graphModal .modal-header h4").html("修改知识图谱")//更换弹出框名称
			$("#graphUrl").val("../../kgmanager/edit")//更换接口地址
			$("#graphModal input[name=graph_mark]").attr("disabled",true)//知识图谱的唯一ID代号修改时无法做更改
			// 修改知识图谱信息回填
			$("#graphModal input[name=title]").val(graphList[i].kgName);//知识图谱名称
			$("#graphModal input[name=graph_mark]").val(graphList[i].kgId);//知识图谱的唯一id编号
			$("#graphModal input[name=graph_url1]").val(graphList[i].kgUrlAskQuestion);//询问问题接口地址
			$("#graphModal input[name=graph_url2]").val(graphList[i].kgUrlUsefulFadeback);//有无帮助反馈接口
			$("#graphModal input[name=graph_url3]").val(graphList[i].kgUrlInputGuide)//输入引导接口地址
			$("#graphModal input[name=graph_url4]").val(graphList[i].kgUrlEntity)//实体获取接口
			$("#graphModal input[name=graph_url5]").val(graphList[i].kgUrlProperty)//属性获取接口
			$("#graphModal input[name=graph_url6]").val(graphList[i].kgUrlRelation)//关系获取接口
			$("#graphModal input[name=graph_url7]").val(graphList[i].kgUrlConcept)//概念获取接口
			$("#graphModal input[name=kgRobotWeight]").val(graphList[i].kgRobotWeight)//机器人答案的置信度倾斜
			$("#graphModal textarea[name=info]").val(graphList[i].kgRemark)//简介备注说明
			$("#graphModal input[name=graph_class]").val(graphList[i].kgImplClass)//实现类的名称

			$('#graphModal').modal("show")
		}
		// 列出表格
		function listGraphPage(pageNo){
			//不勾选全选
			$('.select_rows').iCheck('uncheck');
			if(!pageNo)pageNo=1;
			$('#konwledgeGraphList').tableAjaxLoader2(7);
			$.ajax({
				type:'get',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI('../../kgmanager/listConf?pageSize='+10+'&pageNo='+pageNo),
				success:
				function(data){
					if(data.status===0){
						if(!data.list[0]){
							// $('.select_rows').iCheck('uncheck');
							$('#konwledgeGraphList').find('tbody').html('<tr><td colspan="7" style="text-align:center;"><i class="glyphicon glyphicon-warning-sign"></i>&nbsp;&nbsp;当前纪录为空！</td></tr>');
							$('#pageList').html('');
							return;
						}
						if(data.list.length>0){
							graphList=data.list;
							var html = [];
							listthirdOpenPageData = data.list;
							for(var i=0;i<data.list.length;i++){
								html+= '<tr id="list-tr-'+data.list[i].Id+'">';
								// html.push( '<td><input type="checkbox" name="ckb" class="select_row" value="'+data.list[i].Id+'" /></td>');
								if(data.list[i].kgName===null){
									html+= '<td></td>';
								}else{
									html+= '<td>'+data.list[i].kgName+'</td>';
								};
								if(data.list[i].kgImplClass===null){
									html+= '<td></td>';
								}else{
									html+= '<td>'+data.list[i].kgImplClass+'</td>';
								}
								if(data.list[i].createTime===null){
									html+= '<td></td>';
								}else{
									var time=new Date(data.list[i].createTime)
									var Ntime=time.toLocaleDateString()
									html+= '<td>'+Ntime+'</td>';
								}
								html+='<td><a href="javascript:;" class="sepV_a"  title="编辑" style="cursor:pointer" onclick="editGraph('+i+')" ><i class="glyphicon glyphicon-pencil"></i></a>&nbsp;&nbsp; <a href="javascript:;" class="m-del" title="删除" rel="'+data.list[i].id+'" relNew="'+data.list[i].kgId+'" style="cursor:pointer;" ><i class="glyphicon glyphicon-trash" ></i></a></td>';
								html+='</tr>';
							}
							$('#konwledgeGraphList').find('tbody').html(html);
							//下面开始处理分页
							var options = {
								data: [data, 'list', 'total'],
								currentPage: data.currentPage,
								totalPages: data.totlePages,
								onPageClicked: function (event, originalEvent, type, page) {
									listGraphPage(page);
								}
							};
							setPage('pageList',options);
						}else{
							$('#konwledgeGraphList').find('tbody').html('<tr><td colspan="7" style="text-align:center;"><i class="glyphicon glyphicon-warning-sign"></i>&nbsp;&nbsp;当前纪录为空！</td></tr>');
							$('#pageList').html('');
						}
					}else{
						yunNoty(data);
					}
				}
			});
		}

		//删除单个知识图谱
		$("#konwledgeGraphList").on("click",".m-del",function(){
			$("#delModal #delMark").val($(this).attr("relNew"))
			$("#delModal").modal("show");
		})
		// 删除单个知识图谱请求
		function delGraph(id){
			$.ajax({
				type:'post',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI("../../kgmanager/delete"),
				data:{
					kgId:id
				},
				success:
				function(data){
					if(data.status===0){
						yunNoty(data);
						$('#delModal').modal('hide');
						listGraphPage(1);
					}else{
						yunNoty(data);
					}
				}
			});
		}

	</script>
</body>
</html>
