<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>模块管理</title>
<!-- ================== BEGIN BASE CSS STYLE ================== -->
<link href="../../assets/plugins/jquery-ui/themes/base/minified/jquery-ui.min.css" rel="stylesheet" />
<link href="../../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="../../assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
<link href="../../assets/css/animate.min.css" rel="stylesheet" />
<link href="../../assets/css/style.min.css" rel="stylesheet" />
<link href="../../assets/plugins/gritter/css/jquery.gritter.css" rel="stylesheet" />
<link href="../../assets/css/style-responsive.min.css" rel="stylesheet" />
<link href="../../assets/css/theme/default.css" rel="stylesheet" id="theme" />
<!-- ================== END BASE CSS STYLE ================== -->
<style>
.nano {
	height: 400px;
}
.nano .pane {
	width: 8px;
	right: 1px;
	margin: 5px;
}
.nano .slider {
	background: #f4f5f6;
}
input, select {
	border-radius: 5px;
    border: 1px solid #ccc;
    outline: none;
    padding: 5px 0;
}
</style>
<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
<script src="../../js/html5.js"></script>
<![endif]-->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
</head>
<body>
<section class="section">
<div id="page-container" class="fade in">
	<div id="content" class="content">
		<!-- begin breadcrumb -->
        <ol class="breadcrumb pull-right">
            <li><a href="javascript:;">首页</a></li>
            <li><a href="javascript:;">人员管理</a></li>
            <li>模块管理</li>
        </ol>
        <!-- end breadcrumb -->
        <!-- begin page-header -->
        <h1 class="page-header">模块管理</h1>
        <!-- end page-header -->
	<div class="panel">
		<div class="panel panel-inverse">
			<div class="panel-body">
				<div class="col-md-12">
					<div class="col-md-3" style="min-width:157px; margin-left:0px;">
						<span class="expandAll glyphicon glyphicon-plus-sign" style="cursor:pointer;" title="展开所有"></span>
						<span class="expandNot glyphicon glyphicon-minus" style="cursor:pointer;" title="折叠所有"></span>
						<ul id="treeClasses" class="ztree">
						</ul>
					</div>
					<div class="col-md-9">
						<div class="tabbable" id="pills-115841">
							<ul class="nav nav-pills">
								<li class="active"><a href="#panel-605121" data-toggle="tab">添加模块</a></li>
								<li><a href="#panel-349816" data-toggle="tab">修改模块</a></li>
							</ul>
							<div class="tab-content">
								<div class="tab-pane active" id="panel-605121">
									<form id="addSource_form">
										<div class="div1">
											<label class="bold">
												添加模块名称
											</label>
											<input type="text" name="name" class="col-md-12">
										</div>
										<div class="div2">
											<label class="bold">
												模块级别
											</label>
											<select name="level" class="col-md-12">
												<option value="0" selected>子系统</option>
												<option value="1">模块</option>
											</select>
										</div>
										<div class="div2_1">
											<label class="bold">
												版本模块级别
											</label>
											<select name="moduleLevel" class="col-md-12">
												<option value="-1" selected>系统权限</option>
												<option value="2">免费版权限</option>
												<option value="3">商用版权限</option>
												<option value="4">高级版权限</option>
												<option value="5">专业版权限</option>
											</select>
										</div>
										<div class="div3">
											<label class="bold">
												所属权限系统
											</label>
											<select name="parentId" class="col-md-12">
											</select>
										</div>

										<button type="button" class="save btn btn-primary label_margin" style="margin-top: 20px;"><i class="icon-share icon-white"></i>保存</button>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</section>
<div class="modal hide " id="delpSModal">
	<div class="modal-header">
		<button class="close" aria-hidden="true" data-dismiss="modal" type="button">×</button>
		<h4>删除答案</h4>
	</div>
	<div class="modal-body">
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="col-md-12">
					<p>
						确定删除该角色吗？
					</p>
					<form id="delSId">
						<input type="hidden" name="Id">
					</form>
				</div>
			</div>
		</div>
	</div>
	<div class="modal-footer">
		<a href="javascript:void(0)" class="btn btn-info">&nbsp;确&nbsp;定&nbsp;</a><a href="javascript:void(0)" data-dismiss="modal" class="btn">&nbsp;取&nbsp;消&nbsp;</a>
	</div>
</div>
<!-- ================== BEGIN BASE JS ================== -->
    <script src="../../assets/plugins/jquery/jquery-1.9.1.min.js"></script>
    <script src="../../assets/plugins/jquery/jquery-migrate-1.1.0.min.js"></script>
    <script src="../../assets/plugins/jquery-ui/ui/minified/jquery-ui.min.js"></script>
    <script src="../../assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
        <script src="../../assets/crossbrowserjs/html5shiv.js"></script>
        <script src="../../assets/crossbrowserjs/respond.min.js"></script>
        <script src="../../assets/crossbrowserjs/excanvas.min.js"></script>
    <![endif]-->
    <script src="../../assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script src="../../assets/plugins/jquery-cookie/jquery.cookie.js"></script>
    <!-- ================== END BASE JS ================== -->
    
    <!-- ================== BEGIN PAGE LEVEL JS ================== -->
    <script src="../../assets/js/apps.min.js"></script>
    <!-- ================== END PAGE LEVEL JS ================== -->

    <!-- 必加开始 -->
    <link href="../../assets/plugins/bootstrap-datetimepicker/css/datetimepicker.css" rel="stylesheet" />
    <link rel="stylesheet" href="../common/css/radioskin/blue.css">
    <link rel="stylesheet" href="../common/css/zTreeStyleTest.css">
    <link href="../../assets/plugins/lightbox/css/lightbox.css" rel="stylesheet" />

    <script src="../../assets/plugins/gritter/js/jquery.gritter.js"></script>
    <script src="../../assets/plugins/lightbox/js/lightbox-2.6.min.js"></script>
    <script src="../../assets/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../../assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script src="../common/js/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="../common/js/bootstrap-paginator.js"></script>
    <script src="../common/js/icheck.js"></script>
    <script src="../common/js/jquery.ztree.all-3.5.js"></script>
    <script src="../common/js/customMethod.js"></script>
    <script src="../common/js/base.js"></script>
    <!-- 必加结束 -->

    
    <script>
        $(document).ready(function() {
            App.init();
        });
    </script>
    <script>
;
$(function() {
	//公用方法  

	function _Base() {}

	_Base.prototype = {
		request: function(options) {
			var This = this,
				params = { //必须参数  
					//  
				},
				defaults = {
					prefix: '../../',
					//接口路径前缀(不能写根路径)  
					formId: '',
					//被序列化的formId  
					dataObj: {},
					callback: function() {},
					//回调函数  
				},
				options = $.extend({}, defaults, options);
			formData = $.extend({}, This.formatSeriData(decodeURIComponent(($('#' + options.formId).serialize()))), options.dataObj); //中文乱码,使用decodeURIComponent解码即可  
			$.ajax({
				url: encodeURI(options.prefix + (options.url || '...')),
				//...为基础地址  
				type: 'get',
				dataType: options.dataType || 'json',
				data: $.extend({}, params, options.params, formData),
				cache: false,
				//IE下有用  
				success: function(data) {
					if (data) {
						options.callback(data);
					}
				}
			});
		},
		formatSeriData: function(data) {
			if (!data) {
				return;
			}
			var obj = '',
				dot = ',',
				arr = data.match(/[^&]+/g);

			for (var i = 0; i < arr.length; i++) {
				var str = arr[i].match(/([^=]+)=([^=]*)/);
				if (i == arr.length - 1) {
					dot = '';
				}
				obj += '"' + str[1] + '"' + ":" + '"' + str[2] + '"' + dot;
			}
			return JSON.parse('{' + obj + '}');
		},
		// 判断类型 array number string date function regexp object boolean null undefined  
		isType: function(obj, type) {
			return Object.prototype.toString.call(obj).toLowerCase() === '[object ' + type + ']';
		}
	}

	function Tree(callback) {
		var This = this;
		_Base.call(this);
		$.extend(Tree.prototype, _Base.prototype);
		this.setting = {
			data: {
				simpleData: {
					enable: true,
				},
			},
			view: {
				showIcon: false,
				addHoverDom: function(treeId, treeNode) {
					if(treeNode.id == 1) return;
					var aObj = $("#" + treeNode.tId + "_a");
					if ($(".del_"+treeNode.id).length>0) return;
					var editStr = '<span class="delM del_'+ treeNode.id +' glyphicon glyphicon-trash" style="font-family: \'Glyphicons Halflings\';" onfocus=\'this.blur();\'></span>';

					aObj.append(editStr);
					var btn = $(".del_"+treeNode.id);
					if (btn) btn.on("click", function(){
						This.request({
							url: 'AuthModule/delModule',
							params: {
								id: treeNode.id-1
							},
							callback: function(data) {
								if(data.status) {
									Base.gritter(data.message, false);
								}else {
									Base.gritter(data.message, true);
									location.reload();
								}
							}
						});
					});
				},
				removeHoverDom: function(treeId, treeNode) {
					$(".del_"+treeNode.id).off().remove();
				}
			},
			callback: {
				onClick: function(event, treeId, treeNode) {
					if(event.srcElement.className.indexOf('delM')+1) return;
					callback && callback(treeNode);
				},
			}
		};
		this.init();
	}
	Tree.prototype = {
		init: function() {
			this.getList();
		},
		//获取问题分类
		getList: function() {
			var This = this;
			This.request({
				url: 'AuthModule/listAll',
				params: {
				},
				callback: function(data) {
					if(data.status) {
						Base.gritter(data.message, false);
					}else {
						var html ='';
						if(data.list[0]) {
							var formatData = [],
								len = data.list.length;

							for(var key in data.list) {
								formatData[key] = {};
								formatData[key]['pId'] = data.list[key]['ParentId']+1;
								formatData[key]['mylevel'] = data.list[key]['Level'];
								formatData[key]['moduleLevel'] = data.list[key]['ModuleLevel'];
								formatData[key]['name'] = data.list[key]['Name'] +'('+  data.list[key]['Type'] +')';
								formatData[key]['id'] = data.list[key]['Id']+1;
							}
							formatData[len] = {};
							formatData[len]['name'] = '全部分类';
							formatData[len]['pId'] = 0;
							formatData[len]['id'] = 1;
							formatData[len]['open'] = true;
							$.fn.zTree.init($("#treeClasses"), This.setting, formatData);
						}
					}
				}
			});
		}
	}

	function Resource() {
		_Base.call(this);
		$.extend(Resource.prototype, _Base.prototype);
		this.type = 0;//模块类型
		this.init();
	}
	Resource.prototype = {
		init: function() {
			//this.timePicker();
			this.send();
			this.hide();
			this.getAllModule();
		},
		getAllModule: function() {
			this.request({
				url: 'AuthModule/getAllModule',
				params: {
				},
				callback: function(data) {
					if(data.status) {
						Base.gritter(data.message, false);
					}else {
						if(data.listModule) {
							$('.div3_1').empty();
							var html = '';
							if(data.listModule[0]) {
								for(var i=0; i<data.listModule.length; i++) {
									html += '<option value="'+ data.listModule[i].Id +'" index="'+ i +'">'+ data.listModule[i].Name +'</option>';
								}
							}
							$('.div3>select').empty().append(html);
						}
					}
				}
			});
		},
		//显隐切换
		hide: function() {
			var This = this;
			$('.div3').hide().find('[name]').attr('disabled', 'disabled');
			$('[name=level]').on('change', function() {
				This.type = +$('[name=level] option:selected').val();
				switch(This.type) {
					case 0://子系统
						$('.div3').hide().find('[name]').attr('disabled', 'disabled');
						break;
					case 1://模块
						$('.div3').show().find('[name]').removeAttr('disabled');
						break;
					
				}
			});
		},
		//提交请求
		send: function() {
			var This = this;
			$('.save').on('click', function() {
				switch(This.type) {
					case 0:
						This.parentId = 0;
						//This.systemId = 0;
						break;
					case 1:
						This.parentId = $('[name=parentId] option:selected').val();
						break;
				}
				var $li = $('.nav-pills li');
				for(var i=0; i<$li.length; i++) {
					if($li.eq(i).is('.active')) {
						if(i) {//修改
							This.request({
								url: 'AuthModule/updateModule',
								params: {
									parentId: This.parentId,
									moduleId: This.moduleId,
									//resourceId: This.resourceId
								},
								formId: 'addSource_form',
								callback: function(data) {
									if(data.status) {
										Base.gritter(data.message, false);
									}else {
										Base.gritter(data.message, true);
										var i=0;
										setInterval(function() {
											i++;
											if(i==50) {
												location.reload();
											}
										}, 50);
									}
								}
							});
						}else {//添加
							This.request({
								url: 'AuthModule/createModule',
								params: {
									parentId: This.parentId,
									//systemId: This.systemId
								},
								formId: 'addSource_form',
								callback: function(data) {
									if(data.status) {
										Base.gritter(data.message, false);
									}else {
										Base.gritter(data.message, true);
										var i=0;
										setInterval(function() {
											i++;
											if(i==50) {
												location.reload();
											}
										}, 50);
									}
								}
							});
						}
						break;
					}
				}
			});
		},
		//日历
		timePicker: function() {
			$('.timePicker').datetimepicker({
				language: 'zh-CN',
				format: 'yyyy-mm-dd hh:ii',
				autoclose: true,
				todayBtn: true,
				minuteStep: 10,
				initialDate: new Date()
			});
		}
	}
	var resource = new Resource();
	new Tree(function(treeNode) {
		resource.moduleId = treeNode.id-1;
		$('.nav-pills li a').eq(1).tab('show');
		$('[name=name]').val(treeNode.name.replace(/\([^\(]+\)$/, ''));
		$('[name=parentId] option[value='+ (treeNode.pId-1) +']').prop('selected', true).siblings().prop('selected', false);
		$('[name=moduleLevel] option[value='+ treeNode.moduleLevel +']').prop('selected', true).siblings().prop('selected', false);
		switch(treeNode.mylevel) {
			case 0:
				$('[name=level] option').eq(0).prop('selected', true).siblings().prop('selected', false);
				break;
			case 1:
				$('[name=level] option').eq(1).prop('selected', true).siblings().prop('selected', false);
				break;
		}
		$('[name=level]').trigger('change');
	});

});
</script>
</body>
</html>