<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>营销设置</title>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <meta content="" name="description" />
    <meta content="" name="author" />
    <!-- ================== BEGIN BASE CSS STYLE ================== -->
    <link href="../../assets/plugins/jquery-ui/themes/base/minified/jquery-ui.min.css" rel="stylesheet" />
    <link href="../../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/css/animate.min.css" rel="stylesheet" />
    <link href="../../assets/css/style.min.css" rel="stylesheet" />
    <link href="../../assets/plugins/gritter/css/jquery.gritter.css" rel="stylesheet" />
    <link href="../../assets/css/style-responsive.min.css" rel="stylesheet" />
    <link href="../../assets/css/theme/default.css" rel="stylesheet" id="theme" />
    <!-- ================== END BASE CSS STYLE ================== -->
    <link href="../common/css/commonCSS.css" rel="stylesheet" />
    <link href="../common/css/radioskin/blue.css" rel="stylesheet">
    <link href="../common/css/zTreeStyleTest.css" rel="stylesheet">
    <link href="../knowledge/css/style.css" rel="stylesheet" />
    <style>
		#popbox{
			text-align:left;
			width:180px;
		}
		#queManual,#keywordDiv{
			display: none;
		}
		#marginright{
			margin-bottom: 10px;
		}
		.suijichange{
			position:relative;
			top:15px;
		}
	</style>
</head>
<body>
<div id="page-container" class="fade in">
    <div id="content" class="content">
        <h1 class="page-header">营销设置</h1>
        <div class="rowNav">
            <div class="panel panel-inverse" data-sortable-id="table-basic-7">
                <div class="panel-body">
                    <div class="alert alert-warning fade in m-b-15">
                   		<div style="display: inline-block;">
                   			<p><strong>友情提示：</strong>1.若选择知识库作为营销内容，则知识库答案的生效规则同样适用于当前营销内容</p>
							<p><strong style="visibility:hidden;">友情提示：</strong>2.营销链接可实现营销内容中的某个关键词变成超链接</p>
                   		</div>        
                        <span class="close" data-dismiss="alert">×</span>
                    </div>
                    <div class="row">
                        <ul class="nav nav-pills">
	                       <li class="active">
								<a href="#marketing_content" data-toggle="tab" aria-ecpanded="true">营销内容设置</a>
	                       </li>
	                       <li>
								<a href="#marketing_link" data-toggle="tab" aria-ecpanded="true" onclick="showMarketingTable(1);">营销链接</a>
	                       </li>
	                    </ul>
	                    <div class="tab-content">
	                    	<!-- 营销内容设置 -->
						    <div class="tab-pane fade in active" id="marketing_content">
						    	<div class="row">
									<div class="col-xs-9" style="min-width:720px">
										<form class="form-horizontal">
											<div class="form-group">
												<label class="col-md-2 control-label">营销名称<span class="red" style="color:red;">&nbsp;&nbsp;*</span></label>
												<div class="col-md-9">
													<input type="text" class="form-control" id="advertise_name" placeholder="请输入营销名称">
												</div>
											</div>
											<div class="form-group">
												<label class="col-md-2 control-label">营销内容<span class="red" style="color: red;">&nbsp;&nbsp;*</span></label>
												<div class="col-md-9">
													<div class="row">
														<ul class="nav nav-pills" id="advertise_type">
									                       <li class="active">
																<a href="#text" data-toggle="tab" aria-ecpanded="true">纯文本</a>
									                       </li>
									                       <li>
																<a href="#konwledgeku" data-toggle="tab" aria-ecpanded="true">知识库</a>
									                       </li>
									                    </ul>
														<div class="tab-content" style='padding:0px;height:auto;'>
															<!-- 纯文本 -->
															<div class="tab-pane fade active in" id="text">
																<textarea name="" id="advertiseContent"  style="height:300px" class="form-control"></textarea>
														    </div>
															<!-- 知识库	 -->
														    <div class="tab-pane fade" id="konwledgeku">
																<a data-toggle="modal" href="#queManualModal" class="btn btn-primary" id="changeQue">选择营销问题</a>
																<a href="../../web/knowledge/addQuestion.html"  data-num="0" data-name="添加问题"  class="btn btn-primary hide" id="addQue">新增营销问题</a>
																<div id="selectQue" style="margin-top: 10px">
																	<!-- 选择营销问题内容填充部分 -->
																</div>
															</div>
														</div>			
													</div>
												</div>
											</div>
											<div class="form-group">
												<label class="col-xs-2 control-label text-right" style="position:relative;padding-top: 0;padding-right:20px;">
													<span style="position:relative;bottom:3px">触发机制</span>
													<i class="fa fa-question-circle" id="popi" style="font-size: 20px;"></i>
												</label>
												<div class="col-xs-9">
													<div class="form-group col-xs-7" id="marginright">
														<input type="checkbox"  class="form-control muiSelInp" name="" id="knowledge"><span>&nbsp&nbsp问题&nbsp&nbsp</span>
														<input type="checkbox"  class="form-control muiSelInp" name=""  id="keyword"><span>&nbsp&nbsp关键词&nbsp&nbsp</span>
														<input type="checkbox"  class="form-control muiSelInp" name="" id="shuiji"><span>&nbsp&nbsp随机推荐&nbsp&nbsp</span>
														<p id="suijinew" style="color:red;display: none" class="m-t-4 suijichange">
															<!-- 注意：此营销触发问题已被删除，触发机制已设置为随机推荐 -->
														</p>
													</div>
													<div class="form-group col-xs-12" id="queManual">
														<div class="QueContainer row">
															<div class="form-group col-xs-7">
																<input class="form-control" type="text" readonly="" style="cursor:pointer;" placeholder="暂无数据，待被问后自动填充智能推荐问题，也可点击手动选择推荐问题" name="postQueInput" rel="0" srel="">
															</div>
															<div class="form-group col-xs-3 m-l-5"><a href="javascript:;" name="delpostInput" class="m-l-5"><span class="fa fa-minus-circle fa-2x"></span></a>&nbsp;<a href="javascript:;" name="addpostInput" class="m-l-5"><span class="fa fa-plus-circle fa-2x"></span></a></div>
														</div>
													</div>
													<div class="form-group col-xs-12" id="keywordDiv">
														<div class="row">
															<div class="form-group col-xs-7">
																<input type="text" class="form-control"  placeholder="">
																<div class="col-xs-9" style="padding-left: 0;">
																	注：多个关键词用逗号隔开
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="col-xs-6 col-xs-offset-2" style="padding-left: 4px;">
												<button type="button" class="btn btn-primary" onclick="addAdvertise()" style="margin-right: 1px">保存</button>
												<a href="../../web/temp/marketList.html" data-num="0" data-name="营销列表" class="btn btn-primary m-r-4">返回</a>
											</div>
										</form>
									</div>
						    	</div>
						    </div>
	                   		<!-- 营销链接 -->
							<div class="tab-pane fade" id="marketing_link">
								<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#marketing_link_modal" id="addyinxiao">添加营销链接</button>
								<!-- 营销表格 -->
								<div id="MarketingTable">
									<table class='table'>
										<thead>
											<tr>
												<th>关键词</th>
												<th>链接类型</th>
												<th>添加时间</th>
												<th width="80">操作</th>
											</tr>
										</thead>
										<tbody>
										</tbody>
									</table>
									<div id="marketingList" style="margin:0;"></div>
								</div>
							</div>
	                    </div>
					</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 选择营销问题模态框 -->	
<div class="modal fade" style="display: none;" aria-hidden="true" id="queManualModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
				<h4 class="modal-title">选择营销内容</h4>
			</div>
			<div class="modal-body">
				<form method="POST" id="search_Que" class="form-inline" style="position: relative;">
					<fieldset>
						<div id="menuContent" class="form-group" style="display: inline-block; position: absolute; left: 0; top: 35px; background-color: #fff; border: 1px solid #E4E4E4; z-index: 500; border-radius:4px;">
							<div class="treeDivOfConfigure" tabindex="0" id="classTree">
								<ul id="treeHide" class="ztree" style="margin-top:0;"></ul>
							</div>
						</div>
						<input type="hidden" name="level" value="1">
						<input type="hidden" name="groupId" class="selQueX" value="0">
						<input type="hidden" name="isLeaf" value="0">
						<div class="form-group" style="margin-left:4px;height:20px;">
							<label class="control-label" style="padding-top: 0px">选择分类：</label>
							<a id="queSel" onClick="showMenu(); return false;" style="cursor:pointer;">全部分类</a>
						</div>
						<div class="form-group" style=" float:right;display:flex;margin-right:4px;">
							<input type="text" style="display:none;">
							<input type="text" class="form-control input-sm" name="question" style="margin-right:10px;">
							<button type="button" class="btn btn-primary btn-sm" onClick="addQueSearch();"><i class="glyphicon glyphicon-search"></i></button>
						</div>
						<div id="queDiv form-group" style="margin-top:5px;">
							<ul class="nav nav-pills" id="queDivNav">
								<li class="active"><a href="#queManualQue" data-toggle="tab">问题</a></li>
								<li class=""><a href="#queManualFlow" data-toggle="tab">流程</a></li>
							</ul>
							<div class="tab-content" style="margin-bottom:0;padding:0;">
								<div class="tab-pane fade active in" id="queManualQue">
									<div id="queManualQueTable">
										<table class="table" id="ansList">
											<thead>
												<tr>
													<th width="75">选择</th>
													<th>问题</th>
												</tr>
											</thead>
											<tbody>
											</tbody>
										</table>
									</div>
									<div id="quepageList" style="margin:0;"></div>
								</div>
								<div class="tab-pane fade" id="queManualFlow">
									<div id="queManualFlowTable">
										<table class="table" id="flowList">
											<thead>
												<tr>
													<th width="75">选择</th>
													<th>流程</th>
												</tr>
											</thead>
											<tbody>
											</tbody>
										</table>
									</div>
									<div id="flowpageList" style="margin:0;"></div>
								</div>
							</div>
						</div>
					</fieldset>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-sm btn-primary" href="javascript:;" id="queManualConfirm">确定</button>
				<a data-dismiss="modal" class="btn btn-sm btn-white" href="javascript:;">关闭</a>
			</div>
		</div>
	</div>
</div>
<!-- 删除确定模态框 -->
<div class="modal fade" style="display: none;" aria-hidden="true" id="delLModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
				<h4 class="modal-title">确认删除？</h4>
			</div>
			<div class="modal-body">
				<p>确定要删除您所选的内容？</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-sm btn-primary" href="javascript:;" id="delConfirm">确定</button>
				<a data-dismiss="modal" class="btn btn-sm btn-white" href="javascript:;">关闭</a>
			</div>
		</div>
	</div>
</div>	
<!-- 添加营销链接模态框 -->
<div class="modal fade" style="display: none;" aria-hidden="true" id="marketing_link_modal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
				<h4 class="modal-title">添加营销链接</h4>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<input type="hidden" name="linkId" id="linkId" value="" />
					<div class="form-group">
						<label for="marketing_link_keyword" class="col-xs-2 control-label">关键词</label>
						<div class="col-xs-9">
							<input type="text" class="form-control" id="marketing_link_keyword" placeholder="请输入营销关键词">
						</div>
					</div>
					<div class="form-group">
						<label for="marketing_link_type" class="col-xs-2 control-label">链接类型</label>
						<div class="col-xs-9 ">
							<div id="marketing_link_type" style='padding-top: 5px'>								
								<input type="radio" name="link_type" id="out_link_radio"><span style="margin-left:4px;position:relative;top:2px">外部链接</span>	
								<input type="radio" name="link_type" id="in_link_radio"><span style="margin-left:4px;position:relative;top:2px">内部链接</span>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label class="col-xs-2 control-label"></label>
						<div class="col-xs-9 ">
						    <div id="outside_link">
								<input type="text" class="form-control" id="marketing_link_url" placeholder="请输入链接地址，列如http://www.iyunwen.com">
						    </div>
						    <div id="inside_link"  style="display:none">
								<textarea name="ans_richtext" class="" id="ans_richtext" maxlength="20000"></textarea>
						    </div>
						</div>
					</div>


					<div class="form-group">
						<label for="marketing_link_type" class="col-xs-2 control-label"></label>
						<div class="col-xs-8 ">
							<button type="button" class="btn btn-primary" href="javascript:;" id="link_submint">保存</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
</body>
	<!-- ================== BEGIN BASE JS ================== -->
	<script src="../../assets/plugins/jquery/jquery-1.9.1.min.js"></script>
	<script src="../../assets/plugins/jquery/jquery-migrate-1.1.0.min.js"></script>
	<script src="../../assets/plugins/jquery-ui/ui/minified/jquery-ui.min.js"></script>
	<script src="../../assets/plugins/bootstrap/js/bootstrap.min.js"></script>
	<!--[if lt IE 9]>
	<script src="../../assets/crossbrowserjs/html5shiv.js"></script>
	<script src="../../assets/crossbrowserjs/respond.min.js"></script>
	<script src="../../assets/crossbrowserjs/excanvas.min.js"></script>
	<![endif]-->
	<script src="../../assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
	<script src="../../assets/plugins/jquery-file-upload/js/jquery.fileupload.js"></script>
	<script src="../common/js/jquery.ztree.all-3.5.js"></script>
	<!-- ================== END BASE JS ================== -->

	<!-- ================== BEGIN PAGE LEVEL JS ================== -->
	<script src="../../assets/js/apps.min.js"></script>
	<!-- ================== END PAGE LEVEL JS ================== -->

	<!-- 必加开始 -->
	<link href="../common/css/radioskin/blue.css" rel="stylesheet">
	<script src="../../assets/plugins/gritter/js/jquery.gritter.js"></script>
	<script src="../common/js/bootstrap-paginator.js"></script>
	<script src="../common/js/customMethod.js"></script>
	<script src="../common/js/jquery.validate.js"></script>
	<script src="../common/js/jquery.validate.custom.js"></script>
	<script src="../common/js/iframeTab.min.js"></script>
	<script src="../common/js/icheck.js"></script>
	<script src="../common/js/base.js"></script>
	<!-- 富文本 -->
	<script type="text/javascript" src="../common/js/ueditor/ueditor.config.js"></script>
	<script type="text/javascript" src="../common/js/ueditor/ueditor.all.js"> </script>
	<script type="text/javascript" src="../common/js/ueditor/lang/zh-cn/zh-cn.js"></script>
	<!-- 必加结束 -->
	<script>
		$(document).ready(function(){
			iframeTab.init({iframeBox: ''});
			// $("#shuiji").iCheck('check');
			ChuFaDiv();
			//是否显示新增营销问题按钮

			if(sessionStorage.getItem('advertiseAddShow') == 0){
			    $('#addQue').addClass('hide');
			}else if(sessionStorage.getItem('advertiseAddShow') == 1){
                $('#addQue').removeClass('hide');
			}
		})

		// 触发机制绑定事件
		function ChuFaDiv(){
			//是否显示问题input框
			$('#knowledge').on('ifChecked', function(){
				$("#queManual").show();
				newCss()
			}).on('ifUnchecked',function(){
				$("#queManual").hide();
				newCss()
			});
			
			//是否显示关键字input框
			$('#keyword').on('ifChecked', function(){
				$("#keywordDiv").show();
				newCss()
			}).on('ifUnchecked',function(){
				$("#keywordDiv").hide();
				newCss()
			});
		}

		// suijinew显示框是否居中函数
		function newCss(){
			if($('#knowledge').is(':checked')||$('#keyword').is(':checked')){
				$("#suijinew").removeClass("suijichange")
			}else{
				$("#suijinew").addClass("suijichange")
			}
		}


	 	//修改营销时获取地址advertiseId
		function UrlSearch(){
		   var name,value; 
		   var str=location.href; //取得整个地址栏
		   var num=str.indexOf("?") 
		   str=str.substr(num+1); //取得所有参数   stringvar.substr(start [, length ]
		   var arr=str.split("&"); //各个参数放到数组里
		   for(var i=0;i < arr.length;i++){ 
		   num=arr[i].indexOf("="); 
			    if(num>0){ 
			     	name=arr[i].substring(0,num);
			     	value=arr[i].substr(num+1);
			     	this[name]=value;
			    } 
		    } 
		} 
		var Request=new UrlSearch(); //实例化
		var advertiseId = Request.advertiseId;
		if(advertiseId){
			editAdver(advertiseId);
		}
		
		$('#queManual').on('click', 'a[name=delpostInput]', function() {
			if($('#queManual a[name=delpostInput]').size()>1) {
				$(this).parent().parent().remove();
			} else {
                $('#queManual [name=postQueInput]').removeAttr('rel');
                $('#queManual [name=postQueInput]').removeAttr('srel');
				$('#queManual [name=postQueInput]').val('');
			}
		});
		$('#queManual').on('click', 'a[name=addpostInput]', function() {
			if($('#queManual a[name=addpostInput]').size() < 5) {
				$('#queManual').append('<div class="QueContainer row"><div class="form-group col-xs-7"><input class="form-control" type="text" readOnly style="cursor:pointer;" placeholder="暂无数据，待被问后自动填充智能推荐问题，也可点击手动选择推荐问题" name="postQueInput" rel="0"></div><div class="form-group col-xs-3 m-l-5"><a href="javascript:;" name="delpostInput" class="m-l-5"><span class="fa fa-minus-circle fa-2x"></span></a>&nbsp;<a href="javascript:;" name="addpostInput" class="m-l-5"><span class="fa fa-plus-circle fa-2x"></span></a></div></div>');
			}
		});
		// 触发机制浮动框
		$('#popi').tooltip({
			'html':true,
			'title':'<div id="popbox"><p>触发机制：</p><p>1.问题：访客咨询到该问题时推送广告</p><p>2.关键词；访客咨询的问题中包括该关键词，推送广告</p><p>3.随机推荐：访客与机器人寒暄3个随机问题以上，随机推送一个营销广告</p></div>',
			'template':'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
		});
		// 展示营销列表
		function showMarketingTable(pageNo){
			if(!pageNo)pageNo=1;
			$.ajax({
				type:'post',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI("../../Advertise/listAdvertiseLink?pageSize=10&pageNo="+pageNo),
				success:function(data){
					var Items=data.list;
					if(Items.length>0){
						var htmlstr="";
						for(let i=0;i<Items.length;i++){
							// 链接类型
							let type=( Items[i].linkType===0?"外部链接":"内部链接");
							// 链接名称
							let name=Items[i].Name;
							// 添加时间
							let addtime=Items[i].AddTime; 
							// htmlstr+="<tr><td>"+name+"</td><td>"+type+"</td><td>"+addtime+"</td><td><a style='cursor:pointer;' onclick='changemarketing("+Items[i].Id+")'>修改</a >&nbsp&nbsp<a style='cursor:pointer;' onclick='delmarketing("+Items[i].Id+")'>删除</a></td>";
							htmlstr+="<tr><td>"+name+"</td><td>"+type+"</td><td>"+addtime+"</td><td><a><i class='timeTip edit-synonym glyphicon glyphicon-pencil' onclick='changemarketing("+Items[i].Id+")'  title='编辑'></i><i class='timeTip del-synonym glyphicon glyphicon-trash' onclick='delmarketing("+Items[i].Id+")' title='删除'></i></a></td>";
						}
						$("#MarketingTable").find("tbody").html(htmlstr);
						//下面开始处理分页
						var options = {
							data: [data, 'list', 'total'],
							currentPage: data.CurrentIndex,
							totalPages: data.totlePages,
							onPageClicked: function (event, originalEvent, type, page) {
								showMarketingTable(page);
							}
						};
						setPage('marketingList',options);
					}else {
						$("#MarketingTable").find("tbody").html('<tr><td colspan=\"4\" style=\"text-align:center;\"><i class=\"glyphicon glyphicon-warning-sign\"></i>&nbsp;&nbsp;当前纪录为空！</td></tr>');
						$('#marketingList').html('');
					}
					$('.timeTip').tooltip();
				}

			})
		}
		//智能推荐树
		var hidesetting = {
			view: {
				dblClickExpand: false,
				showIcon: false
			},
			data: {
				simpleData : {
				enable : true,
				idKey : "Id",
				pIdKey : "ParentId",
				rootPId : 0
				},
				key : {
					name : "Name"
				}
			},
			async : {
				enable : true,
				url : "../../classes/listClasses?m=0",
				autoParam : ["id"],
				dataFilter : ajaxDataFilter
			},
			callback: {
				onClick: function(event, treeId, treeNode, clickFlag){
					var treeObj = $.fn.zTree.getZTreeObj(treeId);
					Nodes = treeObj.getSelectedNodes();
					$('#queSel').html(Nodes[0].Name);
					var array = treeObj.getNodesByFilter(filterP, false, treeNode);
					if(array.length > 0) {
						var groupId = '';
						for(var i in array) {
							groupId += (array[i].Id) + ',';
						}
						$('.selQueX').val(groupId);
					} else {
						$('.selQueX').val(treeNode.Id);
					}
					$("#menuContent").fadeOut("fast");
					if($('#queManualQue').hasClass('active')) {
						sQue(1);
					}else if($('#queManualFlow').hasClass('active')) {
						fQue(1);
					}
				},
				onAsyncSuccess: function(event, treeId, treeNode, msg) {
					var treeObj = $.fn.zTree.getZTreeObj(treeId);
					var array = treeObj.getNodesByFilter(filterP);
					if(array.length > 0) {
						var groupId = '';
						for(var i in array) {
							groupId += (array[i].Id) + ',';
						}
						$('.selQueX').val(groupId);
					} else {
						$('.selQueX').val(treeNode.Id);
					}
					if($('#queManualQue').hasClass('active')) {
						sQue(1);
					}else if($('#queManualFlow').hasClass('active')) {
						fQue(1);
					}
				},
				beforeClick:hidezTreeBeforeClick
			}
		};
		function filterP(node) {
			return (node.isParent == false);
		}
		//格式化一步获取的json数据
		function ajaxDataFilter(treeId, parentNode, responseData) {
			if (responseData) {
				if (responseData.status == -1) {
					yunNoty(responseData);
				}
				responseData.list.push({
					Id: 0,
					ParentId: 0,
					Name: "全部分类",
					open: true
				});
				return responseData.list;
			}
			return responseData;
		}
		function hidezTreeBeforeClick(treeId, treeNode, clickFlag) {
			//return !treeNode.isParent;//当是父节点 返回false 不让选取
			if(treeNode.isParent===true){
				$('#search_Que input[name=isLeaf]').val(0);
			}else{
				$('#search_Que input[name=isLeaf]').val(1);
			}
		}

		// 智能推荐模态窗中的树
		function showMenu() {
			var cityObj = $("#queSel");
			var cityOffset = $("#queSel").offset();
			$("#menuContent").slideDown("fast");
			$("body").bind("mousedown", onBodyDown);
			$('#classTree').slimScroll({
				height: '300px'
			});
		}
		function hideMenu() {
			$("#menuContent").fadeOut("fast");
			$("body").unbind("mousedown", onBodyDown);
		}
		function onBodyDown(event) {
			if (!(event.target.id == "menuBtn" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length>0)) {
				hideMenu();
			}
		}
		
		$('#queManualModal').on('show.bs.modal', function () {
			$.fn.zTree.init($("#treeHide"),hidesetting,[]);
			hideMenu();
		});
		$('#queDivNav a').click(function (e) {
			if($(this).attr('href') == '#queManualQue') {
				sQue();
			} else if($(this).attr('href') == '#queManualFlow') {
				fQue();
			}
		});
		// 绑定智能推荐选择问题方法
		$('#queManual').delegate('[name=postQueInput]', 'click', function() {
			QandFIndex = $(this).parent().parent().index();
			
			$('#queManualModal').modal('show');
			$("#queManualConfirm").unbind("click").bind("click",function(){
				selQue();
			});
		});
		// 绑定知识库选择问题方法
		$('#changeQue').on('click', function() {
			$('#queManualModal').on('show.bs.modal', function () {
				$("#queManualConfirm").unbind("click").bind("click",function(){
					selKnowledgeQue();
				});
			});
		});
		//手动设置智能推荐函数
		function selQue(){
			var id = getSelectedIds_aQue();
			var SolutionId = getSelectedSolutionIds_aQue();
		    var hits = $('#list-tr-'+id).attr('hits');
			var targetInput = $('#queManual [name=postQueInput]').eq(QandFIndex);
			targetInput.attr('rel', id);
			targetInput.attr('Srel', SolutionId);
			targetInput.val($('#ansList #list-tr-'+id).find('td:eq(1)').html());
		    targetInput.parent().prev().children().removeClass('btn-primary').addClass('btn-white');
		    targetInput.parent().prev().children().html('手动推荐');
			$('#queManualModal').modal('hide');
		}
		// 知识库选择问题方法
		function selKnowledgeQue(){
			var id = getSelectedIds_aQue();
			var SolutionId = getSelectedSolutionIds_aQue();
		    var newQue=$('<button class="btn btn-white m-t-5" disabled=""></button>');
		    newQue.attr('rel', id);
			newQue.attr('Srel', SolutionId);
			newQue.html($('#ansList #list-tr-'+id).find('td:eq(1)').html());
			$("#selectQue").empty();
			$("#selectQue").append(newQue);
			$('#queManualModal').modal('hide');
		}
		/**
		* 获取智能推荐选中问题的Id
		* @param {null}
		* @return {Integer} 选中的Id
		*/
		function getSelectedIds_aQue() {
			var cboxs = null;
			if($('#queManualQue').hasClass('active')){
				cboxs = document.getElementsByName('row_sel1');
			}
			else if($('#queManualFlow').hasClass('active')){
				cboxs = document.getElementsByName('row_sel2');
			}
			if(typeof cboxs=="undefined"){
				return -1;
			}
			var inputvalue="";
			for(var i=0;i<cboxs.length;i++){
				if(cboxs[i].checked===true){
					inputvalue=cboxs[i].value;
				}
			}
			return inputvalue;
		}

		/**
		* 获取智能推荐选中流程的Id
		* @param {null}
		* @return {Integer} 选中的Id
		*/
		function getSelectedSolutionIds_aQue() {
			var cboxs = null;
			if($('#queManualQue').hasClass('active')){
				cboxs = document.getElementsByName('row_sel1');
			}
			else if($('#queManualFlow').hasClass('active')){
				cboxs = document.getElementsByName('row_sel2');
			}
			if(typeof cboxs=="undefined"){
				return -1;
			}
			var inputvalue="";
			for(var i=0;i<cboxs.length;i++){
				if(cboxs[i].checked===true){
					inputvalue=cboxs[i].getAttribute('solutionid');
				}
			}
			return inputvalue;
		}
		//选择营销内容中的关键字
		enterSubmit($('#search_Que input[name=question]'),addQueSearch);
		function addQueSearch(){
			if($('#queDivNav li').eq(0).hasClass('active')){
				sQue();
			}else if($('#queDivNav li').eq(1).hasClass('active')){
				fQue();
			}else{
				sQue();fQue();
			}
		}
		// 智能推荐问题模态窗列表
		function sQue(pageNo){
			if(!pageNo)pageNo=1;
			$('#ansList').tableAjaxLoader2(2);
			$.ajax({
				type:'post',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI("../../question/getQueListByMode?pageSize=8&pageNo="+pageNo+"&solutionType=1"),
				data:$("#search_Que").serialize(),
				success:
				function(data){
					if(data.status===0){
						if(data.questionList.length>0){
							var html = "";
							var existIds=[];
							$('#queManual').find('input[name=postQueInput]').each(function(){
								existIds.push($(this).attr('rel')*1);
							});
							for(var i=0;i<data.questionList.length;i++){
								//禁用列表中已经存在的问题
								if($.inArray(data.questionList[i].Id, existIds)>=0){
									html += "<tr id=\"list-tr-"+data.questionList[i].Id+"\" hits='"+data.questionList[i].Hits+"'>";
                                    html += "<td><input disabled='' type=\"radio\" name=\"row_sel1\" value=\""+data.questionList[i].Id+"\" solutionId=\""+data.questionList[i].SolutionId+"\"></td>";
                                    if(data.questionList[i].AnswerStatus==-4){
                                        html += "<td class=\"dueTd\">"+data.questionList[i].Question+"<a class=\"btn btn-xs btn-danger m-l-5\">已过期</a></td>";
                                    }else{
                                        html += "<td style='word-break: break-all;'>"+data.questionList[i].Question+"</td>";
                                    }
                                    html += "</tr>";
								}else{
                                    html += "<tr id=\"list-tr-"+data.questionList[i].Id+"\" hits='"+data.questionList[i].Hits+"'>";
                                    html += "<td><input type=\"radio\" name=\"row_sel1\" value=\""+data.questionList[i].Id+"\" solutionId=\""+data.questionList[i].SolutionId+"\"></td>";
                                    if(data.questionList[i].AnswerStatus==-4){
                                        html += "<td class=\"dueTd\">"+data.questionList[i].Question+"<a class=\"btn btn-xs btn-danger m-l-5\">已过期</a></td>";
                                    }else{
                                        html += "<td style='word-break: break-all;'>"+data.questionList[i].Question+"</td>";
                                    }
                                    html += "</tr>";
                                }
								
							}
							$('#ansList').find('tbody').html(html);
							icheckListInit();
							ChuFaDiv();
							linkTab();
							$('#ansList td').click(function() {
								$(this).parent().find('input[name=row_sel1]').iCheck('check');
							});
							//下面开始处理分页
							var options = {
								currentPage: data.currentPage,
								totalPages: data.totlePages,
								onPageClicked: function (event, originalEvent, type, page) {
									sQue(page);
								}
							};
							setPage('quepageList',options);
						}else{
							if($('#search_Que input[name=question]').val() !==''){
								$('#ansList').find('tbody').html('<tr><td colspan=\"2\" style=\"text-align:center;\"><i class=\"glyphicon glyphicon-warning-sign\"></i>&nbsp;&nbsp;搜索结果为空！</td></tr>');
							} else {
								$('#ansList').find('tbody').html('<tr><td colspan=\"2\" style=\"text-align:center;\"><i class=\"glyphicon glyphicon-warning-sign\"></i>&nbsp;&nbsp;当前纪录为空！</td></tr>');
							}
							$('#quepageList').html('');
						}
					}else{
						yunNoty(data);
					}
				}
			});
		}
		//智能推荐流程模态窗列表
		function fQue(pageNo){
			var data = new FormData($( "#search_Que" )[0]);
			if(!pageNo)pageNo=1;
			$('#flowList').tableAjaxLoader2(2);
			$.ajax({
				type:'post',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI("../../question/getQueListByMode?pageSize=8&pageNo="+pageNo+"&solutionType=2"),
				data:$("#search_Que").serialize(),
				success:
				function(data){
					if(data.status===0){
						if(data.questionList.length>0){
							var html = "";
							var existIds=[];
							$('#queManual').find('input[name=postQueInput]').each(function(){
								existIds.push($(this).attr('rel')*1);
							});
							for(var i=0;i<data.questionList.length;i++){
								//禁用列表中已经存在的问题
								if($.inArray(data.questionList[i].Id, existIds)>=0){
									html += "<tr id=\"list-tr-"+data.questionList[i].Id+"\" hits='"+data.questionList[i].Hits+"'>";
                                    html += "<td><input disabled='' type=\"radio\" name=\"row_sel2\" value=\""+data.questionList[i].Id+"\" solutionId=\""+data.questionList[i].SolutionId+"\"></td>";
                                    if(data.questionList[i].AnswerStatus==-4){
                                        html += "<td class=\"dueTd\">"+data.questionList[i].Question+"<a class=\"btn btn-xs btn-danger b-l-5\">已过期</a></td>";
                                    }else{
                                        html += "<td style='word-break: break-all;'>"+data.questionList[i].Question+"</td>";
                                    }
                                    html += "</tr>";
								}else{
                                    html += "<tr id=\"list-tr-"+data.questionList[i].Id+"\" hits='"+data.questionList[i].Hits+"'>";
                                    html += "<td><input type=\"radio\" name=\"row_sel2\" value=\""+data.questionList[i].Id+"\" solutionId=\""+data.questionList[i].SolutionId+"\"></td>";
                                    if(data.questionList[i].AnswerStatus==-4){
                                        html += "<td class=\"dueTd\">"+data.questionList[i].Question+"<a class=\"btn btn-xs btn-danger b-l-5\">已过期</a></td>";
                                    }else{
                                        html += "<td style='word-break: break-all;'>"+data.questionList[i].Question+"</td>";
                                    }
                                    html += "</tr>";
                                }
								
							}
							$('#flowList').find('tbody').html(html);
							
							icheckListInit();
							ChuFaDiv();
							linkTab();
							$('#flowList td').click(function() {
								$(this).parent().find('input[name=row_sel2]').iCheck('check');
							});
							//下面开始处理分页
							var options = {
								currentPage: data.currentPage,
								totalPages: data.totlePages,
								onPageClicked: function (event, originalEvent, type, page) {
									fQue(page);
								}
							};
							setPage('flowpageList',options);
						}else{
							if($('#search_Que input[name=question]').val() !==''){
								$('#flowList').find('tbody').html('<tr><td colspan=\"2\" style=\"text-align:center;\"><i class=\"glyphicon glyphicon-warning-sign\"></i>&nbsp;&nbsp;搜索结果为空！</td></tr>');}
							else{
								$('#flowList').find('tbody').html('<tr><td colspan=\"2\" style=\"text-align:center;\"><i class=\"glyphicon glyphicon-warning-sign\"></i>&nbsp;&nbsp;当前纪录为空！</td></tr>');
							}
							$('#flowpageList').html('');
						}
					}else{
						yunNoty(data);
					}
				}
			});
		}
		// 内外部链接切换
		$('#out_link_radio').attr("checked",true);
		// 内外部链接切换绑定事件
		function linkTab(){
			$("#out_link_radio").on("ifChanged",function(){
			$("#outside_link").css('display',$(this).prop("checked")?'block':'none');
			})
			$("#in_link_radio").on("ifChanged",function(){
				$("#inside_link").css('display',$(this).prop("checked")?'block':'none');
				$("#outside_link").css('display',$(this).prop("checked")?'none':'block');
			})
		}
		linkTab()
		 UE.getEditor('ans_richtext',{
			toolbars: [
				[
		            'source', '|', 'undo', 'redo', '|',
		            'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor',
		            'selectall', 'cleardoc', '|', 'fontfamily', 'fontsize', '|', 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
		            'link', 'unlink', '|', 'imagenone', 'simpleupload', 'insertimage', 'emotion', 'insertvideo', 'attachment', 'map', 'insertframe', 'horizontal', 'date', 'time','wordimage'
		        ]
			],
			initialFrameHeight: 180,
			wordCount:true,
			maximumWords: 20000,
			retainOnlyLabelPasted: true,
			pasteplain:true 
		});
		var flagAdd = true;
		$("#addyinxiao").click(function(){
			$('#marketing_link_modal h4').html('添加营销链接');
			$('#outside_link').css('display','block');
			$('#inside_link').css('display','none');
			$('#out_link_radio').iCheck('check');
			$('#in_link_radio').iCheck('uncheck');
			flagAdd = true;
		});
		// 清空营销链接内容
		$('#marketing_link_modal').on('hide.bs.modal', function (e) {
			$('#marketing_link_keyword').val("");
			$('#marketing_link_url').val("");
			UE.getEditor('ans_richtext').setContent("");
		});
		// 新增营销链接
		function add_link(id){
			// 营销链接关键字
			let Keyword=$("#marketing_link_keyword").val();
			if(Keyword === '' || Keyword.length < 2 || Keyword.length > 50) {
				yunNotyError("营销链接关键字长度需在2-50个字符之间！");
				return false;
			}
			// 链接类型 
			let linktype=$("#out_link_radio").prop("checked")?0:1;
			if(linktype===0){	
				// 外部链接
				var linkurl=$("#marketing_link_url").val();
				var urlreg=/(((^https?:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)(( ?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)$/g;
				var linkhead=linkurl.substring(0,4)
				if(linkurl == ''){
					yunNotyError("链接地址不能为空！");
					return false;
				}else if(!linkurl.match(urlreg)){
					yunNotyError("这不是一个网址！");
					return false;
				}else if(linkhead==="www."){
					linkurl="https://"+linkurl;
				}
				var datajson={
					KeyWord:Keyword,
					linkType:linktype,
					linkUrl:linkurl
				}
			}else if(linktype===1){
				// 内部链接内容
				var linkcontext=UE.getEditor('ans_richtext').getContent();
				if(linkcontext === '' || linkcontext.length < 2 || linkcontext.length > 20000) {
					yunNotyError("答案长度需在2-20000个字符之间！");
					return false;
				}
				var datajson={
					KeyWord:Keyword,
					linkType:linktype,
					linkContext:linkcontext
				}
			}	
			if(id){
				datajson.linkId = id;
			}
			$.ajax({
				type:'post',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI("../../Advertise/editAdvertiseLink"),
				data:datajson,
				success:function(data){
					yunNoty(data);
					if(data.status===0){
						$("#marketing_link_modal").modal('hide');
						showMarketingTable(1);
					}	
				}
			})
		}	
		$('#link_submint').unbind("click").bind("click",function(){
			if(flagAdd){
				add_link();
			}else{
				add_link($("#linkId").val());
			}
		});		
		// 修改营销链接
		function changemarketing(linkid){
			flagAdd = false;
			$('#marketing_link_modal h4').html('修改营销链接');
			$("#linkId").val(linkid);
			$.ajax({
				type:'post',
				datatype:'json',
				cache:false,//不从缓存中去数据
				url:encodeURI("../../Advertise/findBylinkId?id="+linkid),
				success:function(data){
					$('#marketing_link_modal').modal('show');
			 		$("#marketing_link_keyword").val(data.Name);
			 		$('#marketing_link_modal input').iCheck('uncheck');
					if(data.linkType===0){
						$('#out_link_radio').iCheck('check');
						$("#marketing_link_url").val(data.LinkUrl)
					}else if(data.linkType===1){
						$('#in_link_radio').iCheck('check');
						UE.getEditor('ans_richtext').setContent(data.LinkValue);
					}
				}
			})	
		}
		// 删除营销链接
		function delmarketing(linkid){
			$('#delLModal').modal('show')
			$('#delConfirm').unbind("click").bind("click",function(){
				$.ajax({
					type:'post',
					datatype:'json',
					cache:false,//不从缓存中去数据
					url:encodeURI("../../Advertise/deleteAdvertiseLink"),
					data:{
						id:linkid,
					},
					success:function(data){
						if(data.status == 0){
							yunNoty(data);
							$('#delLModal').modal('hide');
							showMarketingTable(1);
						}else{
							yunNotyError(data.message);
						}
					}
				})
			})
		}
		// 保存营销内容
		function addAdvertise(){
			var Advertisedata={};
			// 营销广告名称
			var advertiseName1=$("#advertise_name").val();
			if(advertiseName1 === '' || advertiseName1.length < 2 || advertiseName1.length > 30) {
				yunNotyError("营销广告名称长度需在2-30个字符之间！");
				return false;	
			}else{
				Advertisedata.advertiseName=advertiseName1;
			}
			// 营销广告内容类型
			var contextype=null;
			if($("#advertise_type li:eq(0)").hasClass("active")){
				contextype=0;
				//营销广告内容，纯文本
				var advertiseContent=$("#advertiseContent").val()
				if(advertiseContent === '' || advertiseContent.length < 2 || advertiseContent.length > 2000){
					yunNotyError("营销广告内容长度需在2-2000个字符之间！");
					return false;				
				}else{
					Advertisedata.answer=advertiseContent;
				}
				//营销广告内容，知识库
			}else if($("#advertise_type li:eq(1)").hasClass("active")){
				contextype=1;
				Advertisedata.answerSolutionId=$("#selectQue button").attr("Srel")/1;
			}
			Advertisedata.contexType=contextype;
			var flag = true;
			// 触发机制整形数组
			var arr=[];
			if($('#keyword').is(':checked')){
				arr.push(0);
				//关键字数组
				if($("#keywordDiv input").val() != ""){
					var keyarr1 = $("#keywordDiv input").val().split(/，|,/);
					var keyarr2=[];
					$.each(keyarr1,function(index,value){
					  if(value){
					    keyarr2.push(value);
					  }
					});
					Advertisedata.keyWord = keyarr2.join(",");
					flag = true;
				}else{
					yunNotyError('请填写关键字！');
					flag = false;
				}
			}
			if($('#knowledge').is(':checked')){
				if($('#queManual').find('input[name=postQueInput]').val() != ''){
					//知识点ID数组
					var knowledgeArr=[];
					$('#queManual').find('input[name=postQueInput]').each(function(){
						if($(this).attr('srel')){
							knowledgeArr.push($(this).attr('srel')*1);
						}
					});
					Advertisedata.solutionId=knowledgeArr.join(",");
					arr.push(1);
				}else{
					yunNotyError('请选择一个问题！');
					flag = false;
				}
			}
			if($('#shuiji').is(':checked')){
				arr.push(2);
			}
			Advertisedata.advertiseType = arr.join(",");
			if(advertiseId){
				Advertisedata.advertiseId = advertiseId;
			}
			if(!($('#keyword').is(':checked')) && !($('#knowledge').is(':checked')) && !($('#shuiji').is(':checked'))){
				yunNotyError('请至少选择一个机制！');
			}else{
				if(flag){
					$.ajax({
						type:'post',
						dataType:'json',
						cache:false,//不从缓存中去数据
						url:encodeURI("../../Advertise/editAdvertise"),
						data:Advertisedata,
						success:function(data){
							if(data.status == 0){
								var ifT = iframeTab.init({iframeBox: ''});
								var href = '';
								yunNoty(data,function(){
									var ifT = iframeTab.init({iframeBox: ''});
									ifT.closeActIframe('',parent.$('#tabHeader li[data-num="'+getUrlParam('tmpNum')+'"]').attr('data-tab'));
								});
							}else{
								yunNotyError(data.message);
							}
						}
					})
				}
			}
			
		}
		// 编辑时数据回填
		function editAdver(advertiseId){
			$.ajax({
				type:"POST",
				url:"../../Advertise/advertiseList?advertiseId="+advertiseId,
				async:true,
				cache:true,
				success:function(data){
					if(data.status == 0){
						if(data.advertise){
							if(data.advertise.Name){
								$("#advertise_name").val(data.advertise.Name);
							}
							if(data.advertise.AdvMode == 1){//知识库
								$('#advertise_type li:eq(1)').addClass('active');
								$('#advertise_type li:eq(0)').removeClass('active');
								$("#text").removeClass('active in');
								$("#konwledgeku").addClass('active in');
								$("#selectQue").html('<button class="btn btn-white m-t-5" disabled="" rel="'+data.advertise.ModeValue+'" srel="'+data.advertise.ModeValue+'">'+data.answerQuestion+'</button>');
							}else{
								$('#advertise_type li:eq(0)').addClass('active');
								$('#advertise_type li:eq(1)').removeClass('active');
								$("#text").addClass('active in');
								$("#konwledgeku").removeClass('active in');
								if(data.advertise.Answer){
									$("#advertiseContent").text(data.advertise.Answer);
								}
							}
						}
						if(data.list.length > 0){
							$('#queManual').html('');
							for(var i = 0;i < data.list.length;i++){
								if(data.list.length > 5){
									$('#queManual').append('');
								}else{
									$('#queManual').append('<div class="QueContainer row"><div class="form-group col-xs-7"><input class="form-control" type="text" readOnly style="cursor:pointer;" placeholder="暂无数据，待被问后自动填充智能推荐问题，也可点击手动选择推荐问题" name="postQueInput" rel="'+data.list[i].Id+'" srel="'+data.list[i].Id+'"></div><div class="form-group col-xs-3 m-l-5"><a href="javascript:;" name="delpostInput" class="m-l-5"><span class="fa fa-minus-circle fa-2x"></span></a>&nbsp;<a href="javascript:;" name="addpostInput" class="m-l-5"><span class="fa fa-plus-circle fa-2x"></span></a></div></div>');
								}
								$('.QueContainer [name="postQueInput"]').eq(i).val(data.list[i].Question);
							}
						}else{
							$('#queManual').html('<div class="QueContainer row"><div class="form-group col-xs-7"><input class="form-control" type="text" readOnly style="cursor:pointer;" placeholder="暂无数据，待被问后自动填充智能推荐问题，也可点击手动选择推荐问题" name="postQueInput" rel="0"></div><div class="form-group col-xs-3 m-l-5"><a href="javascript:;" name="delpostInput" class="m-l-5"><span class="fa fa-minus-circle fa-2x"></span></a>&nbsp;<a href="javascript:;" name="addpostInput" class="m-l-5"><span class="fa fa-plus-circle fa-2x"></span></a></div></div>');
						}
						if(data.advertiseType){
							var keyWords = '';
							for(var i = 0;i < data.advertiseType.length; i++){
								if(data.advertiseType[i].Type == 0){
									if(data.advertiseType[i].TypeValue){
										keyWords += data.advertiseType[i].TypeValue+',';
									}
									$("#keyword").iCheck('check');
								}
								if(data.advertiseType[i].Type == 1){
									$("#knowledge").iCheck('check');
									if(data.list.length===0){
										$("#knowledge").iCheck('uncheck');
										$("#shuiji").iCheck('check');
									}
								}
								if(data.advertiseType[i].Type == 2){
									$("#shuiji").iCheck('check');
									if(data.advertiseType[i].TypeValue!==null){
										var str="注意:"+data.advertiseType[i].TypeValue;
										$("#suijinew").css("display","block")
										$("#suijinew").html(str)
									}
								}
								$("#keywordDiv input").val(keyWords.substring(0,keyWords.length-1));
							}
						}
					}
				}
			});

		}
	</script>
</html>
